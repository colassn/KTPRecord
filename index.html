<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>娛樂基地 Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: -apple-system, "SF Pro Display", "Noto Sans TC", sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f5f5f7; color: #1d1d1f; }
.no-scrollbar::-webkit-scrollbar { display: none; }
/* 極光背景動畫 */
.mesh-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #ffffff; z-index: -2; overflow: hidden; }
.mesh-blob { position: absolute; filter: blur(90px); opacity: 0.6; animation: float 20s infinite alternate; }
.blob-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: #c084fc; animation-delay: 0s; }
.blob-2 { bottom: -10%; right: -10%; width: 70vw; height: 70vw; background: #818cf8; animation-delay: -5s; }
.blob-3 { top: 40%; left: 40%; width: 50vw; height: 50vw; background: #f472b6; animation-delay: -10s; }
@keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 30px) scale(1.1); } }

/* 高級玻璃質感 */
.glass-panel { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05); }
.glass-dock { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1); }
.glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
.glass-input { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.3s ease; }
.glass-input:focus { background: rgba(255, 255, 255, 0.8); border-color: #818cf8; box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2); }

/* Toast Notification Animation */
@keyframes slide-up-fade {
    0% { transform: translate(-50%, 100%); opacity: 0; }
    100% { transform: translate(-50%, 0); opacity: 1; }
}
.toast-anim { animation: slide-up-fade 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

.locked-element { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }
@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fade-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
</style>
</head>
<body>
<div class="mesh-bg"><div class="mesh-blob blob-1 rounded-full"></div><div class="mesh-blob blob-2 rounded-full"></div><div class="mesh-blob blob-3 rounded-full"></div></div>
<div id="root"></div>
<script type="text/babel">
const firebaseConfig = { apiKey: "AIzaSyAaOvxEx2gFin7caKmK8WFUZW2akue03M0", authDomain: "ktpsave.firebaseapp.com", projectId: "ktpsave", storageBucket: "ktpsave.firebasestorage.app", messagingSenderId: "1085218871782", appId: "1:1085218871782:web:afa68ab315fe8b3dbe5e27", measurementId: "G-WZQ61MP067" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); const db = firebase.firestore();
const { useState, useEffect, useMemo, useRef } = React;

const Icons = {
    Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
    History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
    LayoutDashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
    Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
    Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
    ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>,
    Table: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>,
    CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
    Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
    Whatsapp: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
    Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
    Empty: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
    Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>,
    Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
    Message: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>,
    Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
    Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
    Store: () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
    Crown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M2 4l3 12h14l3-12-6 7-4-13-4 13z"/></svg>,
    Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
    Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
};

const formatDate = (date) => { let m = '' + (date.getMonth() + 1), d = '' + date.getDate(), y = date.getFullYear(); if (m.length < 2) m = '0' + m; if (d.length < 2) d = '0' + d; return [y, m, d].join('-'); };
const formatCurrency = (n) => { if(isNaN(n) || n === null) return '$0'; return new Intl.NumberFormat('zh-HK', { style: 'currency', currency: 'HKD', minimumFractionDigits: 0 }).format(n); };
const formatTime = (ts) => { if(!ts) return ''; const d = new Date(ts.seconds * 1000); return `${d.getMonth()+1}月${d.getDate()}日 ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };

// --- Toast Component ---
const Toast = ({ show, msg }) => (
    <div className={`fixed bottom-32 left-1/2 -translate-x-1/2 z-50 pointer-events-none toast-box ${show ? 'toast-show' : ''}`}>
        <div className="bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm flex items-center gap-2 border border-white/10 ring-1 ring-white/20">
             {msg}
        </div>
    </div>
);

// --- Welcome Screen ---
const WelcomeScreen = ({ onSelect }) => (
    <div className="min-h-screen flex flex-col items-center justify-center p-6 animate-enter relative z-10">
        <h1 className="text-4xl font-black text-slate-800 mb-2 tracking-tighter">娛樂基地</h1>
        <p className="text-slate-500 text-sm font-bold tracking-widest uppercase mb-12">Select Store Location</p>
        
        <div className="w-full max-w-sm space-y-6">
            <div onClick={() => onSelect(STORES.kwun_tong)} className="store-card glass-panel p-6 rounded-3xl cursor-pointer hover:bg-white/80 group">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                            <Icons.Store />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">觀塘廣場店</h2>
                            <p className="text-xs text-slate-500 font-medium">Game-Zone</p>
                        </div>
                    </div>
                    <div className="text-slate-300 group-hover:text-blue-500 transition-colors"><Icons.ArrowRight /></div>
                </div>
            </div>

            <div onClick={() => onSelect(STORES.camel_paint)} className="store-card glass-panel p-6 rounded-3xl cursor-pointer hover:bg-white/80 group">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white shadow-lg shadow-purple-200">
                            <Icons.Store />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">駱駝漆店</h2>
                            <p className="text-xs text-slate-500 font-medium">StayTrue</p>
                        </div>
                    </div>
                    <div className="text-slate-300 group-hover:text-purple-500 transition-colors"><Icons.ArrowRight /></div>
                </div>
            </div>
        </div>
        <div className="mt-12 text-[10px] text-slate-400">v6.4 Manual Add System</div>
    </div>
);

// --- Store Configuration ---
const STORES = {
    kwun_tong: {
        id: 'kwun_tong',
        name: '觀塘廣場店',
        engName: 'Game-Zone',
        color: 'from-blue-500 to-cyan-500',
        collections: { machines: 'machines', records: 'daily_records', memos: 'memos', links: 'links' }, // Legacy paths
        defaultMachines: [
            { id: '1', name: '機台 1', owner: '台主在場', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '2', name: '機台 2', owner: '62778117', phone: '62778117', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '3', name: '機台 3', owner: '群組', phone: '91696461', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '4', name: '機台 4', owner: '97859062', phone: '97859062', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '5', name: '機台 5', owner: '大家姐', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '6', name: '機台 6', owner: '西裝', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' },
            { id: '7', name: '機台 7', owner: '大家姐', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' }
        ]
    },
    camel_paint: {
        id: 'camel_paint',
        name: '駱駝漆店',
        engName: 'StayTrue',
        color: 'from-purple-500 to-pink-500',
        collections: { machines: 'camel_machines', records: 'camel_daily_records', memos: 'camel_memos', links: 'camel_links' }, // New paths
        defaultMachines: [
            ...Array.from({length:15}, (_,i)=>({ id: `${i+1}`, name: `${i+1}`, owner: '', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'single' })),
            ...['A','B','C','D','E','F'].map(c=>({ id: c, name: c, owner: '', phone: '', coinValue: 5, isOwnerMachine: false, inputMode: 'dual' }))
        ]
    }
};

// --- Main Store App ---
const StoreApp = ({ storeConfig, onBack }) => {
    const { collections } = storeConfig;
    const [user, setUser] = useState(null);
    const [activeTab, setActiveTab] = useState('input');
    const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
    const [machines, setMachines] = useState([]);
    const [dailyData, setDailyData] = useState({});
    const [extraData, setExtraData] = useState({ previousCash: '', exchangeMachineCash: '' });
    const [historyData, setHistoryData] = useState([]);
    const [memos, setMemos] = useState([]);
    const [links, setLinks] = useState([]);
    const [loading, setLoading] = useState(true);
    const [cashCounts, setCashCounts] = useState({ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 });
    const [openMonths, setOpenMonths] = useState({});
    const [isAdmin, setIsAdmin] = useState(false);
    const [showLogin, setShowLogin] = useState(false);
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [toast, setToast] = useState({ show: false, msg: '' });
    
    // Memo Inputs
    const [memoName, setMemoName] = useState('');
    const [memoText, setMemoText] = useState('');
    const PRESET_NAMES = ['Hin', 'Yo', '馬', '西裝友'];

    useEffect(() => { auth.signInAnonymously().catch(console.error); return auth.onAuthStateChanged(setUser); }, []);
    useEffect(() => { const s=localStorage.getItem('isAdmin'); if(s==='true') setIsAdmin(true); }, []);

    const handleLogin = (e) => { e.preventDefault(); if(username==='Colason'&&password==='Colason'){ setIsAdmin(true); localStorage.setItem('isAdmin','true'); setShowLogin(false); setUsername(''); setPassword(''); } else alert('錯誤'); };
    const handleLogout = () => { setIsAdmin(false); localStorage.removeItem('isAdmin'); alert('已登出'); };
    const showToast = (msg) => { setToast({show:true, msg}); setTimeout(()=>setToast({show:false, msg:''}), 2000); };

    // Fetchers
    useEffect(() => { 
        if (!user) return; 
        return db.collection(collections.machines).onSnapshot(snap => { 
            if (snap.empty) { 
                storeConfig.defaultMachines.forEach(m => db.collection(collections.machines).doc(m.id).set(m)); 
                setMachines(storeConfig.defaultMachines); 
            } else { 
                const loaded = snap.docs.map(d => {
                    const data = d.data();
                    // FORCE FIX: Ensure Camel Paint numeric machines are single input
                    if (storeConfig.id === 'camel_paint') {
                        if (/^\d+$/.test(d.id)) {
                             data.inputMode = 'single';
                        } else {
                             data.inputMode = 'dual';
                        }
                    } else {
                        // Kwun Tong is all dual
                        data.inputMode = 'dual';
                    }
                    return {id: d.id, ...data};
                }); 
                // Custom sort: Numeric first, then Mini A-F
                loaded.sort((a,b) => {
                    const nA = parseInt(a.id), nB = parseInt(b.id);
                    if(!isNaN(nA) && !isNaN(nB)) return nA - nB;
                    if(!isNaN(nA)) return -1;
                    if(!isNaN(nB)) return 1;
                    return a.id.localeCompare(b.id);
                });
                setMachines(loaded); 
            } 
            setLoading(false); 
        }); 
    }, [user, collections]);

    useEffect(() => { 
        if (!user) return; 
        return db.collection(collections.records).doc(selectedDate).onSnapshot(doc => { 
            if (doc.exists) { const d = doc.data(); setDailyData(d.records||{}); setCashCounts(d.cashCounts||{ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 }); setExtraData(d.extraData||{ previousCash: '', exchangeMachineCash: '' }); } 
            else { setDailyData({}); setCashCounts({ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 }); setExtraData({ previousCash: '', exchangeMachineCash: '' }); } 
        }); 
    }, [user, selectedDate, collections]);

    useEffect(() => { 
        if (!user) return; 
        return db.collection(collections.records).onSnapshot(snap => { 
            const recs = snap.docs.map(d => ({ date: d.id, ...d.data() })).filter(r => r.date.match(/^\d{4}-\d{2}-\d{2}$/)); 
            recs.sort((a, b) => b.date.localeCompare(a.date)); 
            setHistoryData(recs); 
        }); 
    }, [user, collections]);

    useEffect(() => { if (historyData.length > 0 && Object.keys(openMonths).length === 0) setOpenMonths({ [historyData[0].date.substring(0, 7)]: true }); }, [historyData]);
    
    useEffect(() => { 
        if (!user) return; 
        return db.collection(collections.memos).orderBy('createdAt', 'desc').onSnapshot(snap => { 
            const list = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
            setMemos(list); 
        }); 
    }, [user, collections]);
    
    // Links Fetcher
    useEffect(() => {
        if (!user) return;
        return db.collection(collections.links).onSnapshot(snap => {
            if (snap.empty) {
                const defaultLinks = [
                    { title: '數錢', url: 'https://colassn.github.io/Money/' },
                    { title: '紙幣智能分發機', url: 'https://colassn.github.io/Money/givemoney.html' },
                    { title: '對幣機計算器', url: 'https://colassn.github.io/StayTrue5Cal/' }
                ];
                defaultLinks.forEach(l => db.collection(collections.links).add(l));
            } else {
                const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                setLinks(list);
            }
        });
    }, [user, collections]);


    // Handlers
    const handleCountChange = (id, field, val, coinVal, isSingle) => { 
        if (!isAdmin) return; 
        const amt = isNaN(parseFloat(val)) ? '' : parseFloat(val) * (coinVal || 5); 
        
        if (isSingle) {
            setDailyData(prev => ({ ...prev, [id]: { ...(prev[id]||{}), upper: amt, lower: 0 } }));
        } else {
            setDailyData(prev => ({ ...prev, [id]: { ...(prev[id]||{}), [field]: amt } }));
        }
    };
    
    const handleCopy = (m) => {
        const r = dailyData[m.id]||{}; const u = Number(r.upper) || 0; const l = Number(r.lower) || 0; const t = u + l;
        const isSingle = m.inputMode === 'single';

        let msg = '';
        if (isSingle) {
             msg = `今天對幣 (${m.name})：\n數量：${u/ (m.coinValue||5)} (個)\n總額：$${t}`;
        } else {
             msg = `今天對幣 (${m.name})：\n上層：$${u}\n下層：$${l}\n總共：$${t}`;
        }
        navigator.clipboard.writeText(msg).then(() => showToast('已複製到剪貼簿')).catch(() => alert('複製失敗'));
    };

    const saveData = async () => { if (!user || !isAdmin) return; const processed = {}; const allIds = new Set([...machines.map(m=>m.id), ...Object.keys(dailyData)]); allIds.forEach(id => { const r = dailyData[id]||{}; processed[id] = { upper: r.upper||'', lower: r.lower||'', total: (Number(r.upper)||0)+(Number(r.lower)||0), isPaid: r.isPaid||false }; }); await db.collection(collections.records).doc(selectedDate).set({ records: processed, cashCounts, extraData, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); alert('資料已儲存！'); };
    const deleteRecord = async (date) => { if(!isAdmin) return; if(confirm(`刪除 ${date} 紀錄？`)) await db.collection(collections.records).doc(date).delete(); };
    const deleteMonth = async (month, recs) => { if(!isAdmin) return; if(confirm(`刪除 ${month} 所有資料 (${recs.length}筆)？`)) { const batch = db.batch(); recs.forEach(r => batch.delete(db.collection(collections.records).doc(r.date))); await batch.commit(); alert('已刪除月份資料'); } };
    const addMemo = async () => { if (!memoName.trim()) return alert('請輸入姓名'); if (!memoText.trim()) return alert('請輸入內容'); try { await db.collection(collections.memos).add({ name: memoName, text: memoText, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); setMemoText(''); } catch(e) { console.error(e); alert('留言失敗'); } };
    const deleteMemo = async (id) => { if (!isAdmin) return; if (confirm('刪除此留言？')) await db.collection(collections.memos).doc(id).delete(); };
    
    const toggleOwnerMachine = async (machine) => {
        if (!isAdmin) return;
        const newVal = !machine.isOwnerMachine;
        const updatedMachine = { ...machine, isOwnerMachine: newVal };
        await db.collection(collections.machines).doc(machine.id).set(updatedMachine);
    };

    // MANUAL ADD MACHINE
    const handleAddMachine = async () => {
        const defaultId = (machines.reduce((max,m)=>{const n=parseInt(m.id); return isNaN(n)?max:Math.max(max,n);},0)+1).toString();
        const id = prompt("請輸入新機台編號 (例如: 16 或 G)", defaultId);
        if (!id) return;
        if (machines.some(m => m.id === id)) return alert('機台編號已存在！');

        try {
            await db.collection(collections.machines).doc(id).set({
                id: id,
                name: storeConfig.id === 'kwun_tong' ? `機台 ${id}` : id, // Camel uses just ID as name
                owner: '', 
                phone: '', 
                coinValue: 5,
                isOwnerMachine: false
            });
            alert(`成功新增機台：${id}`);
        } catch (e) {
            console.error(e);
            alert('新增失敗: ' + e.message);
        }
    };
    
    // Links Handlers
    const handleAddLink = async () => {
        const title = prompt("請輸入工具名稱：");
        if (!title) return;
        const url = prompt("請輸入網址：", "https://");
        if (!url) return;
        
        try {
            await db.collection(collections.links).add({ title, url });
            showToast('已新增工具連結');
        } catch (e) {
            console.error(e);
            alert("新增失敗");
        }
    };
    
    const handleDeleteLink = async (id) => {
        if (confirm("確定刪除此工具連結？")) {
             await db.collection(collections.links).doc(id).delete();
             showToast('已刪除連結');
        }
    };
    
    const handleEditLink = async (link) => {
        const newTitle = prompt("修改名稱：", link.title);
        if (newTitle === null) return;
        const newUrl = prompt("修改網址：", link.url);
        if (newUrl === null) return;
        
        await db.collection(collections.links).doc(link.id).update({
            title: newTitle,
            url: newUrl
        });
        showToast('已更新連結');
    };

    // --- Daily Summary Table ---
    const DailySummaryTable = ({ machines, data, cashCounts, extraData, readOnly=false, onTogglePaid }) => {
        const allIds = useMemo(() => Array.from(new Set([...machines.map(m=>m.id), ...Object.keys(data||{})])).sort((a,b)=>{
             const nA = parseInt(a), nB = parseInt(b);
             if(!isNaN(nA) && !isNaN(nB)) return nA - nB;
             if(!isNaN(nA)) return -1; if(!isNaN(nB)) return 1;
             return a.localeCompare(b);
        }), [machines, data]);
        const machineMap = useMemo(() => { const map={}; machines.forEach(m=>map[m.id]=m); return map; }, [machines]);
        const totalMachineRevenue = allIds.reduce((sum, id) => { const r = data[id]||{}; return sum + (Number(r.upper)||0) + (Number(r.lower)||0); }, 0);
        const currentCash = ((cashCounts?.['1000']||0)*1000) + ((cashCounts?.['500']||0)*500) + ((cashCounts?.['100']||0)*100) + ((cashCounts?.['50']||0)*50) + ((cashCounts?.['20']||0)*20) + ((cashCounts?.['10']||0)*10) + (Number(cashCounts?.['coins'])||0);
        const previousCash = Number(extraData?.previousCash)||0;
        const totalCash = currentCash + previousCash;
        const profitLoss = totalCash - totalMachineRevenue;

        return (
            <div className="glass-panel rounded-3xl overflow-hidden mt-6 shadow-sm animate-enter delay-3">
                <div className="bg-white/40 px-5 py-4 border-b border-white/40 flex items-center gap-2 backdrop-blur-md">
                    <div className="text-indigo-600 bg-indigo-50 p-1.5 rounded-lg"><Icons.Table /></div>
                    <h3 className="font-bold text-slate-800 text-sm">營收結算表</h3>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead><tr className="bg-indigo-50/50 text-indigo-900/60 text-[10px] uppercase font-bold tracking-wider"><th className="px-4 py-3 pl-6">機台</th><th className="px-2 py-3 text-right">上數</th><th className="px-2 py-3 text-right">下數</th><th className="px-2 py-3 text-right text-indigo-700">總計</th><th className="px-2 py-3 text-center">派彩</th></tr></thead>
                        <tbody className="divide-y divide-white/40">
                            {allIds.map((id, idx) => {
                                const m = machineMap[id] || {name:`${id} (已刪)`, owner:'-', inputMode: 'dual'}; const r = data[id]||{}; const total = (Number(r.upper)||0)+(Number(r.lower)||0);
                                const isSingle = m.inputMode === 'single';

                                if(!machineMap[id] && total===0) return null;
                                return (
                                    <tr key={id} className={`hover:bg-white/40 transition-colors ${idx%2===0?'bg-white/10':''}`}>
                                        <td className="px-4 py-3 pl-6">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-xl bg-gradient-to-br ${storeConfig.color} text-white flex items-center justify-center text-[10px] font-bold shadow-md`}>{id}</div>
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-slate-700 flex items-center gap-1">
                                                        {m.name}
                                                        {m.isOwnerMachine && <span className="text-[9px] bg-amber-100 text-amber-600 px-1.5 py-0.5 rounded-full border border-amber-200">台主</span>}
                                                    </span>
                                                    <span className="text-[10px] text-slate-500">{m.owner}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-2 py-3 text-right font-mono text-slate-600 text-xs tracking-tight">{r.upper>0?formatCurrency(r.upper).replace('HK$',''):'-'}</td>
                                        <td className="px-2 py-3 text-right font-mono text-slate-600 text-xs tracking-tight">{isSingle ? '-' : (r.lower>0?formatCurrency(r.lower).replace('HK$',''):'-')}</td>
                                        <td className="px-2 py-3 text-right font-bold text-indigo-600 font-mono text-xs tracking-tight">{total>0?formatCurrency(total).replace('HK$',''):'-'}</td>
                                        <td className="px-2 py-3 text-center"><button disabled={readOnly} onClick={()=>onTogglePaid&&onTogglePaid(id, !r.isPaid)} className={`p-1.5 rounded-lg transition-all active:scale-95 ${readOnly?'':'hover:bg-white/60'}`}>{r.isPaid?<div className="text-emerald-500 drop-shadow-sm"><Icons.CheckSquare/></div>:<div className="text-slate-300"><Icons.Square/></div>}</button></td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
                <div className="bg-white/30 p-5 space-y-2 backdrop-blur-sm">
                    <div className="flex justify-between text-sm"><span className="text-slate-500 font-medium">機台總和</span><span className="font-bold text-slate-700 font-mono">{formatCurrency(totalMachineRevenue)}</span></div>
                    <div className="flex justify-between text-sm"><span className="text-slate-500 flex items-center gap-2"><span className="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>本次紙幣</span><span className="font-bold text-emerald-600 font-mono">+ {formatCurrency(currentCash)}</span></div>
                    <div className="flex justify-between text-sm"><span className="text-slate-500 flex items-center gap-2"><span className="w-1.5 h-1.5 rounded-full bg-blue-400"></span>上次紙幣</span><span className="font-bold text-blue-600 font-mono">+ {formatCurrency(previousCash)}</span></div>
                    <div className="my-2 border-t border-slate-400/20 border-dashed"></div>
                    <div className="flex justify-between text-sm"><span className="font-bold text-slate-600">現金總數</span><span className="font-black text-slate-800 font-mono text-base">{formatCurrency(totalCash)}</span></div>
                    <div className={`mt-3 p-4 rounded-2xl flex justify-between items-center shadow-inner ring-1 ring-inset transition-colors ${profitLoss>=0?'bg-emerald-50/50 text-emerald-900 ring-emerald-200/50':'bg-rose-50/50 text-rose-900 ring-rose-200/50'}`}>
                        <span className="font-bold text-xs uppercase tracking-wider opacity-70">盈虧</span><span className="font-black text-2xl tracking-tight font-mono">{profitLoss>0?'+':''}{formatCurrency(profitLoss)}</span>
                    </div>
                    <div className="mt-2 text-[10px] text-slate-400 text-center font-medium">兌幣機記錄: {formatCurrency(Number(extraData?.exchangeMachineCash)||0)}</div>
                </div>
            </div>
        );
    };

    const renderInput = () => {
        const totalRev = machines.reduce((s,m) => s + (Number(dailyData[m.id]?.upper)||0) + (Number(dailyData[m.id]?.lower)||0), 0);
        const currCash = ((cashCounts['1000']||0)*1000)+((cashCounts['500']||0)*500)+((cashCounts['100']||0)*100)+((cashCounts['50']||0)*50)+((cashCounts['20']||0)*20)+((cashCounts['10']||0)*10)+(Number(cashCounts['coins'])||0);
        const pl = (currCash + (Number(extraData.previousCash)||0)) - totalRev;

        return (
            <div className="space-y-6 animate-enter">
                <div className="glass-panel p-2 rounded-2xl flex items-center relative overflow-hidden animate-enter delay-0">
                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b ${storeConfig.color}`}></div>
                    <div className="pl-4 py-3 flex-1"><label className="block text-[10px] font-bold opacity-60 uppercase">選擇日期</label><div className="font-black text-slate-700 text-xl flex items-center gap-2"><span className="text-indigo-500"><Icons.Calendar/></span>{selectedDate}</div></div>
                    <button onClick={(e)=>{e.stopPropagation();setSelectedDate(formatDate(new Date()));}} className="relative z-20 mr-2 bg-white/50 hover:bg-white text-indigo-600 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm backdrop-blur-sm border border-white/50 transition-all active:scale-95">今天</button>
                    <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="absolute inset-0 opacity-0 w-full h-full z-10 cursor-pointer"/>
                </div>
                {!isAdmin && <div className="bg-slate-200/80 p-3 rounded-xl text-xs text-slate-600 text-center flex items-center justify-center gap-2 animate-enter delay-1"><Icons.Lock/> 訪客模式：只能查看</div>}
                <div className="space-y-5">
                    {machines.map((m, i) => {
                        const d = dailyData[m.id]||{}; const cv = m.coinValue||5; const sub = (Number(d.upper)||0)+(Number(d.lower)||0);
                        const isSingle = m.inputMode === 'single';

                        return (
                            <div key={m.id} className={`glass-panel rounded-3xl overflow-hidden animate-enter ${!isAdmin?'locked-element':''}`} style={{animationDelay: `${(i+1)*30}ms`}}>
                                <div className="bg-white/40 px-5 py-4 border-b border-white/50 flex justify-between items-center"><div className="flex items-center gap-3"><div className={`w-11 h-11 rounded-2xl bg-gradient-to-br ${storeConfig.color} text-white flex items-center justify-center font-bold text-lg shadow-lg`}>{m.id}</div><div><h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">{m.name} {m.isOwnerMachine && <span className="bg-amber-100 text-amber-600 text-[10px] px-2 py-0.5 rounded-full border border-amber-200 flex items-center gap-1 shadow-sm">台主</span>}</h3><p className="text-[11px] text-slate-500 font-medium">幣值: ${cv}</p></div></div><div className="text-right"><span className="text-[10px] text-slate-400 block font-bold">小計</span><span className="font-black text-indigo-600 text-xl">{formatCurrency(sub).replace('HK$','')}</span></div></div>
                                
                                <div className={`p-5 grid ${isSingle ? 'grid-cols-1' : 'grid-cols-2'} gap-4`}>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400">{isSingle ? '數量 (Count)' : '上層個數'}</label>
                                        <input disabled={!isAdmin} type="number" placeholder="0" value={d.upper?(Number(d.upper)/cv):''} onChange={e=>handleCountChange(m.id,'upper',e.target.value,cv, isSingle)} className="glass-input w-full py-3 px-2 rounded-2xl text-center font-bold text-slate-700 text-lg focus:bg-white outline-none"/>
                                        <div className="text-center text-[10px] text-slate-400">= ${Number(d.upper)||0}</div>
                                    </div>
                                    {!isSingle && (
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-bold text-slate-400">下層個數</label>
                                            <input disabled={!isAdmin} type="number" placeholder="0" value={d.lower?(Number(d.lower)/cv):''} onChange={e=>handleCountChange(m.id,'lower',e.target.value,cv, false)} className="glass-input w-full py-3 px-2 rounded-2xl text-center font-bold text-slate-700 text-lg focus:bg-white outline-none"/>
                                            <div className="text-center text-[10px] text-slate-400">= ${Number(d.lower)||0}</div>
                                        </div>
                                    )}
                                </div>

                                <div className="px-5 pb-5"><button onClick={()=>handleCopy(m)} className="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm flex items-center justify-center gap-2 hover:bg-slate-200 active:scale-95 transition-all"><Icons.Copy/> 複製文字</button></div>
                            </div>
                        )
                    })}
                </div>

                <div className={`glass-panel p-5 rounded-3xl mt-8 animate-enter delay-3 ${!isAdmin?'locked-element':''}`}>
                    <h3 className="font-bold mb-4 text-slate-700 flex items-center gap-2 text-lg"><span className="w-1.5 h-6 rounded-full bg-gradient-to-b from-emerald-400 to-teal-500"></span>現金點算</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {['1000','500','100','50','20','10'].map(d=>(<div key={d} className="relative"><label className="absolute -top-2 left-3 bg-white/90 px-1.5 rounded text-[10px] font-bold text-emerald-600 shadow-sm">${d}</label><div className="flex items-center"><input disabled={!isAdmin} type="number" placeholder="0" value={cashCounts[d]||''} onChange={e=>setCashCounts(prev=>({...prev,[d]:parseFloat(e.target.value)||0}))} className="glass-input w-full py-3 px-4 rounded-xl font-bold text-slate-700 focus:bg-white outline-none"/></div><div className="text-right text-[10px] text-slate-400 mt-1 mr-1 opacity-60">= {formatCurrency((cashCounts[d]||0)*d).replace('HK$','')}</div></div>))}
                        <div className="col-span-2 relative mt-3"><label className="absolute -top-2 left-3 bg-white/90 px-1.5 rounded text-[10px] font-bold text-amber-500 shadow-sm">硬幣總額</label><input disabled={!isAdmin} type="number" placeholder="0" value={cashCounts['coins']||''} onChange={e=>setCashCounts(prev=>({...prev,['coins']:parseFloat(e.target.value)||0}))} className="glass-input w-full py-3 px-4 rounded-xl font-bold text-slate-700 focus:bg-white outline-none"/></div>
                    </div>
                    <div className="mt-5 pt-4 border-t border-slate-200/50 flex justify-between font-bold text-sm"><span className="text-slate-500">本次紙幣小計</span><span className="text-emerald-600 text-xl font-black">{formatCurrency(currCash)}</span></div>
                </div>

                <div className={`glass-panel p-5 rounded-3xl mt-4 space-y-5 animate-enter delay-3 ${!isAdmin?'locked-element':''}`}>
                    <div><label className="text-xs font-bold text-slate-500 ml-1">上次數到的紙幣</label><input disabled={!isAdmin} type="number" placeholder="0" value={extraData.previousCash} onChange={e=>setExtraData(prev=>({...prev,previousCash:e.target.value}))} className="glass-input w-full py-3 px-4 rounded-xl focus:bg-white outline-none font-bold text-slate-700 text-lg"/></div>
                    <div><label className="text-xs font-bold text-slate-500 ml-1">兌幣機現有紙幣</label><input disabled={!isAdmin} type="number" placeholder="0" value={extraData.exchangeMachineCash} onChange={e=>setExtraData(prev=>({...prev,exchangeMachineCash:e.target.value}))} className="glass-input w-full py-3 px-4 rounded-xl focus:bg-white outline-none font-bold text-slate-700 text-lg"/></div>
                </div>

                <DailySummaryTable machines={machines} data={dailyData} cashCounts={cashCounts} extraData={extraData} onTogglePaid={(id,st)=>{if(isAdmin)setDailyData(prev=>({...prev,[id]:{...(prev[id]||{}),isPaid:st}}))}}/>
                
                {/* Memo Board */}
                <div className="glass-panel p-5 rounded-3xl mt-8 animate-enter delay-4">
                    <h3 className="font-bold mb-4 text-slate-700 flex items-center gap-2 text-lg"><span className="w-1.5 h-6 rounded-full bg-indigo-500"></span>留言備忘板</h3>
                    <div className="space-y-3 mb-6 max-h-[400px] overflow-y-auto pr-1">
                        {memos.length === 0 && <div className="text-center text-slate-400 text-xs py-4">暫無留言</div>}
                        {memos.map(memo => (
                            <div key={memo.id} className="bg-white/60 p-3 rounded-2xl rounded-tl-none relative group border border-white/50">
                                <div className="flex justify-between items-start"><div className="flex flex-col"><span className="text-[11px] font-bold text-indigo-600">{memo.name}</span><span className="text-[9px] text-slate-400">{formatTime(memo.createdAt)}</span></div>{isAdmin && <button onClick={()=>deleteMemo(memo.id)} className="text-slate-300 hover:text-rose-500 p-1"><Icons.Trash2/></button>}</div>
                                <div className="mt-1 text-sm text-slate-700 font-medium whitespace-pre-wrap leading-relaxed">{memo.text}</div>
                            </div>
                        ))}
                    </div>
                    <div className="space-y-3 bg-white/40 p-3 rounded-2xl">
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            {PRESET_NAMES.map(name => (<button key={name} onClick={() => setMemoName(name)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap shadow-sm border border-white/20 ${memoName === name ? 'bg-indigo-500 text-white shadow-indigo-200' : 'bg-white/60 text-slate-600 hover:bg-white'}`}>{name}</button>))}
                        </div>
                        <input value={memoName} onChange={e=>setMemoName(e.target.value)} placeholder="輸入您的姓名..." className="w-full bg-white/50 border-none rounded-xl px-3 py-2 text-sm font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-400 outline-none"/>
                        <textarea value={memoText} onChange={e=>setMemoText(e.target.value)} placeholder="輸入備忘事項..." rows="2" className="w-full bg-white/50 border-none rounded-xl px-3 py-2 text-sm text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-400 outline-none resize-none"></textarea>
                        <button onClick={addMemo} className="w-full bg-indigo-500 text-white rounded-xl py-2.5 font-bold text-sm flex items-center justify-center gap-2 hover:bg-indigo-600 active:scale-95 transition-all shadow-lg shadow-indigo-200"><Icons.Message/> 發送留言</button>
                    </div>
                </div>

                <div className="h-40"></div>

                <div className="glass-dock fixed bottom-[85px] left-4 right-4 p-4 rounded-3xl flex justify-between items-center z-40 animate-enter delay-5">
                    <div><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">本日總盈虧</p><p className={`text-2xl font-black tracking-tight ${pl>=0?'text-emerald-500':'text-rose-500'}`}>{pl>0?'+':''}{formatCurrency(pl)}</p></div>
                    {isAdmin ? <button onClick={saveData} className="bg-slate-900 text-white px-8 py-3.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg active:scale-95 text-sm transition-all"><Icons.Save/> 儲存</button> : <button disabled className="bg-slate-300 text-slate-500 px-8 py-3.5 rounded-2xl font-bold flex items-center gap-2 shadow-inner text-sm"><Icons.Lock/> 訪客</button>}
                </div>
                
                <Toast show={toast.show} msg={toast.msg} />
            </div>
        );
    };

    const renderHistory = () => {
        if (!historyData.length) return <div className="flex flex-col items-center py-20 text-slate-400 animate-enter"><Icons.Empty/><p className="mt-4 font-bold text-sm">暫無紀錄，請先新增資料。</p></div>;
        const groups = {}; historyData.forEach(r => { const k=r.date.substring(0,7); if(!groups[k]) groups[k]=[]; groups[k].push(r); });
        return (
            <div className="space-y-6 animate-enter">
                <h2 className="text-3xl font-black text-slate-800 px-1 text-shimmer">歷史紀錄</h2>
                {Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0])).map(([mKey, recs], idx) => {
                    const profit = recs.reduce((acc, r) => { const tr = Object.values(r.records||{}).reduce((s,v)=>s+(Number(v.total)||0),0); const cc = Object.entries(r.cashCounts||{}).reduce((s,[k,v])=>k==='coins'?s+v:s+(v*Number(k)),0); return acc + ((cc + (Number(r.extraData?.previousCash)||0)) - tr); }, 0);
                    const open = openMonths[mKey];
                    return (
                        <div key={mKey} className={`space-y-2 animate-enter`} style={{animationDelay: `${idx*100}ms`}}>
                            <div className={`glass-panel p-4 rounded-3xl flex justify-between items-center transition-all duration-300 ${open?'bg-white/80 ring-2 ring-indigo-200 shadow-lg':'hover:bg-white/60'}`}>
                                <div className="flex items-center gap-3 flex-1 cursor-pointer" onClick={()=>setOpenMonths(p=>({...p,[mKey]:!p[mKey]}))}><div className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-colors shadow-sm ${open?'bg-indigo-500 text-white':'bg-indigo-50 text-indigo-400'}`}><Icons.Folder/></div><div><h3 className="font-bold text-slate-700 text-lg">{mKey.split('-')[0]}年 {mKey.split('-')[1]}月</h3><p className="text-[10px] text-slate-500 font-medium">{recs.length} 筆帳目</p></div></div>
                                <div className="flex items-center gap-3"><div className={`font-black text-lg ${profit>=0?'text-emerald-600':'text-rose-500'}`}>{profit>0?'+':''}{formatCurrency(profit).replace('HK$','')}</div>{isAdmin ? <button onClick={()=>deleteMonth(mKey, recs)} className="w-8 h-8 flex items-center justify-center rounded-full bg-rose-100 text-rose-500 hover:bg-rose-500 hover:text-white transition-all"><Icons.Trash2/></button> : <div className="w-8 h-8 flex items-center justify-center text-slate-300"><Icons.Lock/></div>}</div>
                            </div>
                            {open && <div className="space-y-3 pl-4 border-l-2 border-indigo-100/50 ml-6 pt-2">{recs.map((r, i) => {
                                const tr = Object.values(r.records||{}).reduce((s,v)=>s+(Number(v.total)||0),0); const cc = Object.entries(r.cashCounts||{}).reduce((s,[k,v])=>k==='coins'?s+v:s+(v*Number(k)),0); const p = (cc + (Number(r.extraData?.previousCash)||0)) - tr;
                                return (<div key={r.date} className="glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-white/60 ml-2 animate-enter" style={{animationDelay: `${i*50}ms`}} onClick={()=>{setSelectedDate(r.date);setActiveTab('input');}}><div className="flex items-center gap-3"><span className="font-bold text-slate-700">{r.date.substring(8)}日</span><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-400">查看</span></div><div className="flex items-center gap-3"><span className={`font-black ${p>=0?'text-emerald-500':'text-rose-500'}`}>{Math.round(p)}</span>{isAdmin ? <button onClick={(e)=>{e.stopPropagation();deleteRecord(r.date);}} className="p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-all"><Icons.Trash2/></button> : <span className="p-2 text-slate-300"><Icons.Lock/></span>}</div></div>)
                            })}</div>}
                        </div>
                    );
                })}
            </div>
        );
    };

    const renderSettings = () => (
        <div className="space-y-4 animate-enter">
            <h2 className="text-3xl font-black text-slate-800 px-1 text-shimmer">機台設定</h2>
            
            {/* 訪客提示 */}
            {!isAdmin && <div className="bg-slate-200/80 p-4 rounded-2xl text-sm font-bold text-slate-600 flex items-center justify-center gap-2 mb-4"><Icons.Lock/> 設定已鎖定 (訪客模式)</div>}

            <div className="space-y-3">
                {machines.map((m, i) => (
                <div key={m.id} className="glass-panel p-4 rounded-3xl flex flex-col gap-3 animate-enter" style={{animationDelay: `${i*50}ms`}}>
                    <div className="flex items-center gap-3">
                        <div className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${storeConfig.color} text-white flex items-center justify-center font-bold text-lg shrink-0 shadow-inner`}>{m.id}</div>
                        
                        <div className="flex-1 space-y-2">
                             {/* 機台名稱 input - ReadOnly if !isAdmin */}
                             <input 
                                disabled={!isAdmin} 
                                value={m.name} 
                                onChange={e=>{const n=[...machines];n[i].name=e.target.value;setMachines(n)}} 
                                className={`w-full bg-transparent border-b outline-none font-bold text-slate-700 text-lg ${!isAdmin ? 'border-transparent' : 'border-slate-200 focus:border-indigo-500'}`}
                             />
                             
                             <div className="flex gap-2">
                                <input 
                                    disabled={!isAdmin} 
                                    placeholder="台主" 
                                    value={m.owner} 
                                    onChange={e=>{const n=[...machines];n[i].owner=e.target.value;setMachines(n)}} 
                                    className={`text-xs w-full rounded-lg px-2 py-1.5 border-none font-medium ${!isAdmin ? 'bg-slate-100 text-slate-500' : 'bg-slate-50/50'}`}
                                />
                                <input 
                                    disabled={!isAdmin} 
                                    placeholder="電話" 
                                    value={m.phone} 
                                    onChange={e=>{const n=[...machines];n[i].phone=e.target.value;setMachines(n)}} 
                                    className={`text-xs w-full rounded-lg px-2 py-1.5 border-none text-right font-medium ${!isAdmin ? 'bg-slate-100 text-slate-500' : 'bg-slate-50/50'}`}
                                />
                             </div>
                        </div>

                        {/* Delete Button - Only Admin */}
                        {isAdmin ? (
                            <button onClick={async()=>{if(confirm('刪除?'))await db.collection(collections.machines).doc(m.id).delete()}} className="w-10 h-10 flex items-center justify-center rounded-xl bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all"><Icons.Trash2/></button>
                        ) : (
                            <span className="text-slate-300"><Icons.Lock/></span>
                        )}
                    </div>

                    {/* 台主機 Toggle - Only Admin */}
                    {isAdmin && (
                        <div className="flex justify-end pt-2 border-t border-slate-100/50">
                             <button onClick={() => toggleOwnerMachine(m)} className={`text-xs px-3 py-1.5 rounded-full font-bold flex items-center gap-1 transition-all ${m.isOwnerMachine ? 'bg-amber-100 text-amber-600 ring-1 ring-amber-200' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                <Icons.Crown /> {m.isOwnerMachine ? '已設為台主機' : '設為台主機'}
                             </button>
                        </div>
                    )}
                    {/* For guests, we can show a badge if it is an owner machine, or nothing */}
                    {!isAdmin && m.isOwnerMachine && (
                        <div className="flex justify-end pt-2 border-t border-slate-100/50">
                             <span className="text-xs px-3 py-1.5 rounded-full font-bold flex items-center gap-1 bg-amber-100 text-amber-600 border border-amber-200">
                                台主機
                             </span>
                        </div>
                    )}
                </div>
            ))}</div>

            {/* Bottom Buttons */}
            {isAdmin ? (
                <>
                <button onClick={handleAddMachine} className="w-full py-4 border-2 border-dashed border-slate-300/60 rounded-3xl text-slate-400 font-bold flex justify-center gap-2 hover:border-indigo-400 hover:text-indigo-500 transition-all"><Icons.Plus/> 新增機台</button>
                <button onClick={async()=>{for(const m of machines)await db.collection(collections.machines).doc(m.id).set(m);alert('設定已儲存')}} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl mt-4 active:scale-95 transition-all">儲存設定</button>
                </>
            ) : (
                <button disabled className="w-full bg-slate-300 text-slate-500 py-4 rounded-2xl font-bold shadow-inner mt-4 flex items-center justify-center gap-2">
                    <Icons.Lock/> 權限不足
                </button>
            )}
            
            <div className="h-40"></div>
        </div>
    );
    
    // --- Render Links ---
    const renderLinksTab = () => (
        <div className="space-y-4 animate-enter">
            <h2 className="text-3xl font-black text-slate-800 px-1 text-shimmer">實用工具</h2>
            {!isAdmin && <div className="bg-slate-200/80 p-4 rounded-2xl text-sm font-bold text-slate-600 flex items-center justify-center gap-2 mb-4"><Icons.Lock/> 僅管理員可編輯連結</div>}
            
            <div className="space-y-3">
                {links.map((link) => (
                    <div key={link.id} onClick={() => window.open(link.url, '_blank')} className="glass-panel p-5 rounded-3xl flex items-center justify-between cursor-pointer hover:bg-white/80 transition-all group active:scale-95">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-teal-500 text-white flex items-center justify-center shadow-md">
                                <Icons.Link /> {/* Generic link icon */}
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-700 text-lg">{link.title}</h3>
                                <p className="text-xs text-slate-400 truncate max-w-[150px]">{link.url}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                             <div className="text-slate-300 group-hover:text-emerald-500 transition-colors"><Icons.ArrowRight /></div>
                             {isAdmin && (
                                <div className="flex flex-col gap-2 ml-2" onClick={(e) => e.stopPropagation()}>
                                    <button onClick={() => handleEditLink(link)} className="p-2 bg-slate-100 rounded-full text-slate-400 hover:text-blue-500 hover:bg-blue-50"><Icons.Edit /></button>
                                    <button onClick={() => handleDeleteLink(link.id)} className="p-2 bg-slate-100 rounded-full text-slate-400 hover:text-rose-500 hover:bg-rose-50"><Icons.Trash2 /></button>
                                </div>
                             )}
                        </div>
                    </div>
                ))}
            </div>
            
            {isAdmin && (
                <button onClick={handleAddLink} className="w-full py-4 border-2 border-dashed border-slate-300/60 rounded-3xl text-slate-400 font-bold flex justify-center gap-2 hover:border-emerald-400 hover:text-emerald-500 transition-all mt-4">
                    <Icons.Plus /> 新增工具連結
                </button>
            )}
            
            <div className="h-40"></div>
        </div>
    );


    return (
        <div className="min-h-screen">
            <div className="glass-nav sticky top-0 z-40 mb-6"><div className="max-w-lg mx-auto px-5 py-4 flex justify-between items-center">
                <div onClick={() => onBack()} className="cursor-pointer">
                    <h1 className={`text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r ${storeConfig.color} tracking-tighter`}>{storeConfig.engName}</h1>
                    <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">點擊切換店舖</p>
                </div>
                <div className="flex items-center gap-3"><div className="text-xs font-bold bg-slate-100/80 px-3 py-1.5 rounded-full text-slate-600 shadow-sm border border-white/50">{selectedDate}</div><button onClick={()=>isAdmin?handleLogout():setShowLogin(true)} className={`p-2 rounded-full transition-all active:scale-95 ${isAdmin?'bg-indigo-100 text-indigo-600 shadow-inner':'bg-white shadow-sm text-slate-400'}`}>{isAdmin?<Icons.Unlock/>:<Icons.Lock/>}</button></div>
            </div></div>
            
            {showLogin && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-enter"><div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm border border-white/50"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-slate-800">管理員登入</h3><button onClick={()=>setShowLogin(false)} className="text-slate-400 hover:text-slate-600"><Icons.Close/></button></div><form onSubmit={handleLogin} className="space-y-4"><input type="text" placeholder="帳號" value={username} onChange={e=>setUsername(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700 border border-transparent focus:border-indigo-500 transition-all"/><input type="password" placeholder="密碼" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700 border border-transparent focus:border-indigo-500 transition-all"/><button type="submit" className="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-indigo-500/30 active:scale-95 transition-all">登入</button></form></div></div>}
            
            <Toast show={toast.show} msg={toast.msg} />

            <div className="px-4 max-w-lg mx-auto pb-[400px]">
                {loading ? 
                    <div className="flex flex-col items-center justify-center py-40 space-y-4"><div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div><div className="text-sm font-bold text-slate-400 animate-pulse">系統載入中...</div></div> 
                    : (activeTab==='input'?renderInput():activeTab==='history'?renderHistory():activeTab==='links'?renderLinksTab():renderSettings())
                }
            </div>
            
            <div className="glass-nav fixed bottom-0 left-0 right-0 pb-safe z-30 h-[80px] flex items-center">
                <div className="flex justify-around w-full max-w-lg mx-auto">
                    <button onClick={()=>setActiveTab('input')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-16 h-16 transition-all duration-300 ${activeTab==='input'?'text-indigo-600 bg-indigo-50/50 scale-105 shadow-sm':'text-slate-400 hover:text-slate-600'}`}><Icons.LayoutDashboard/><span className="text-[10px] font-bold mt-1">輸入</span></button>
                    <button onClick={()=>setActiveTab('history')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-16 h-16 transition-all duration-300 ${activeTab==='history'?'text-indigo-600 bg-indigo-50/50 scale-105 shadow-sm':'text-slate-400 hover:text-slate-600'}`}><Icons.History/><span className="text-[10px] font-bold mt-1">歷史</span></button>
                    <button onClick={()=>setActiveTab('links')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-16 h-16 transition-all duration-300 ${activeTab==='links'?'text-indigo-600 bg-indigo-50/50 scale-105 shadow-sm':'text-slate-400 hover:text-slate-600'}`}><Icons.Link/><span className="text-[10px] font-bold mt-1">工具</span></button>
                    <button onClick={()=>setActiveTab('settings')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-16 h-16 transition-all duration-300 ${activeTab==='settings'?'text-indigo-600 bg-indigo-50/50 scale-105 shadow-sm':'text-slate-400 hover:text-slate-600'}`}><Icons.Settings/><span className="text-[10px] font-bold mt-1">設定</span></button>
                </div>
            </div>
        </div>
    );
};

const Root = () => {
    const [currentStore, setCurrentStore] = useState(null);
    return currentStore ? <StoreApp storeConfig={currentStore} onBack={() => setCurrentStore(null)} /> : <WelcomeScreen onSelect={setCurrentStore} />;
};

const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<Root />);
</script>
</body>
</html>