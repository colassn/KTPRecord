<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>娛樂基地 Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: -apple-system, "SF Pro Display", "Noto Sans TC", sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f5f5f7; color: #1d1d1f; }
.no-scrollbar::-webkit-scrollbar { display: none; }
/* 極光背景動畫 */
.mesh-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #ffffff; z-index: -2; overflow: hidden; }
.mesh-blob { position: absolute; filter: blur(90px); opacity: 0.6; animation: float 20s infinite alternate; }
.blob-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: #c084fc; animation-delay: 0s; }
.blob-2 { bottom: -10%; right: -10%; width: 70vw; height: 70vw; background: #818cf8; animation-delay: -5s; }
.blob-3 { top: 40%; left: 40%; width: 50vw; height: 50vw; background: #f472b6; animation-delay: -10s; }
@keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 30px) scale(1.1); } }

/* 高級玻璃質感 */
.glass-panel { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05); }
.glass-dock { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1); }
.glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
.glass-input { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.3s ease; }
.glass-input:focus { background: rgba(255, 255, 255, 0.8); border-color: #818cf8; box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2); }

.locked-element { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }
@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fade-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
</style>
</head>
<body>
<div class="mesh-bg"><div class="mesh-blob blob-1 rounded-full"></div><div class="mesh-blob blob-2 rounded-full"></div><div class="mesh-blob blob-3 rounded-full"></div></div>
<div id="root"></div>
<script type="text/babel">
const firebaseConfig = { apiKey: "AIzaSyAaOvxEx2gFin7caKmK8WFUZW2akue03M0", authDomain: "ktpsave.firebaseapp.com", projectId: "ktpsave", storageBucket: "ktpsave.firebasestorage.app", messagingSenderId: "1085218871782", appId: "1:1085218871782:web:afa68ab315fe8b3dbe5e27", measurementId: "G-WZQ61MP067" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); const db = firebase.firestore();
const { useState, useEffect, useMemo, useRef } = React;

const Icons = {
    Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
    History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
    LayoutDashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
    Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
    Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
    ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>,
    Table: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>,
    CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
    Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
    Whatsapp: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
    Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
    Empty: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
    Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>,
    Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
    Message: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>,
    Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
};

const formatDate = (date) => { let m = '' + (date.getMonth() + 1), d = '' + date.getDate(), y = date.getFullYear(); if (m.length < 2) m = '0' + m; if (d.length < 2) d = '0' + d; return [y, m, d].join('-'); };
const formatCurrency = (n) => { if(isNaN(n) || n === null) return '$0'; return new Intl.NumberFormat('zh-HK', { style: 'currency', currency: 'HKD', minimumFractionDigits: 0 }).format(n); };
const formatTime = (ts) => { if(!ts) return ''; const d = new Date(ts.seconds * 1000); return `${d.getMonth()+1}月${d.getDate()}日 ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };

// --- Summary Table ---
const DailySummaryTable = ({ machines, data, cashCounts, extraData, readOnly=false, onTogglePaid }) => {
    const allIds = useMemo(() => Array.from(new Set([...machines.map(m=>m.id), ...Object.keys(data||{})])).sort((a,b)=>parseInt(a)-parseInt(b)), [machines, data]);
    const machineMap = useMemo(() => { const map={}; machines.forEach(m=>map[m.id]=m); return map; }, [machines]);
    const totalMachineRevenue = allIds.reduce((sum, id) => { const r = data[id]||{}; return sum + (Number(r.upper)||0) + (Number(r.lower)||0); }, 0);
    const currentCash = ((cashCounts?.['1000']||0)*1000) + ((cashCounts?.['500']||0)*500) + ((cashCounts?.['100']||0)*100) + ((cashCounts?.['50']||0)*50) + ((cashCounts?.['20']||0)*20) + ((cashCounts?.['10']||0)*10) + (Number(cashCounts?.['coins'])||0);
    const previousCash = Number(extraData?.previousCash)||0;
    const totalCash = currentCash + previousCash;
    const profitLoss = totalCash - totalMachineRevenue;

    return (
        <div className="glass-panel rounded-3xl overflow-hidden mt-6 shadow-sm animate-fade-in">
            <div className="bg-white/40 px-5 py-4 border-b border-white/40 flex items-center gap-2"><div className="text-indigo-600"><Icons.Table /></div><h3 className="font-bold text-slate-800 text-sm">營收結算表</h3></div>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left">
                    <thead><tr className="bg-indigo-50/50 text-indigo-900/60 text-[10px] uppercase font-bold tracking-wider"><th className="px-4 py-3 pl-6">機台</th><th className="px-2 py-3 text-right">上數</th><th className="px-2 py-3 text-right">下數</th><th className="px-2 py-3 text-right text-indigo-700">總計</th><th className="px-2 py-3 text-center">派彩</th></tr></thead>
                    <tbody className="divide-y divide-white/40">
                        {allIds.map((id, idx) => {
                            const m = machineMap[id] || {name:`${id} (已刪)`, owner:'-'}; const r = data[id]||{}; const total = (Number(r.upper)||0)+(Number(r.lower)||0);
                            if(!machineMap[id] && total===0) return null;
                            return (
                                <tr key={id} className={`hover:bg-white/40 transition-colors ${idx%2===0?'bg-white/10':''}`}>
                                    <td className="px-4 py-3 pl-6"><div className="flex items-center gap-3"><div className="w-7 h-7 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 text-white flex items-center justify-center text-[10px] font-bold shadow-sm">{id}</div><div className="flex flex-col"><span className="font-semibold text-slate-700">{m.name}</span><span className="text-[10px] text-slate-500">{m.owner}</span></div></div></td>
                                    <td className="px-2 py-3 text-right font-mono text-slate-600 text-xs">{r.upper>0?formatCurrency(r.upper).replace('HK$',''):'-'}</td>
                                    <td className="px-2 py-3 text-right font-mono text-slate-600 text-xs">{r.lower>0?formatCurrency(r.lower).replace('HK$',''):'-'}</td>
                                    <td className="px-2 py-3 text-right font-bold text-indigo-600 font-mono text-xs">{total>0?formatCurrency(total).replace('HK$',''):'-'}</td>
                                    <td className="px-2 py-3 text-center"><button disabled={readOnly} onClick={()=>onTogglePaid&&onTogglePaid(id, !r.isPaid)} className={`p-1.5 rounded-lg transition-all active:scale-95 ${readOnly?'':'hover:bg-white/60'}`}>{r.isPaid?<div className="text-emerald-500"><Icons.CheckSquare/></div>:<div className="text-slate-300"><Icons.Square/></div>}</button></td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            <div className="bg-white/30 p-5 space-y-2 backdrop-blur-sm">
                <div className="flex justify-between text-sm"><span className="text-slate-500 font-medium">機台總和</span><span className="font-bold text-slate-700 font-mono">{formatCurrency(totalMachineRevenue)}</span></div>
                <div className="flex justify-between text-sm"><span className="text-slate-500">本次紙幣</span><span className="font-bold text-emerald-600 font-mono">+ {formatCurrency(currentCash)}</span></div>
                <div className="flex justify-between text-sm"><span className="text-slate-500">上次紙幣</span><span className="font-bold text-blue-600 font-mono">+ {formatCurrency(previousCash)}</span></div>
                <div className="my-2 border-t border-slate-300/30 border-dashed"></div>
                <div className="flex justify-between text-sm"><span className="font-bold text-slate-600">現金總數</span><span className="font-bold text-slate-800 font-mono">{formatCurrency(totalCash)}</span></div>
                <div className={`mt-3 p-4 rounded-2xl flex justify-between items-center shadow-inner ring-1 ring-inset ${profitLoss>=0?'bg-emerald-50/50 text-emerald-800 ring-emerald-100':'bg-rose-50/50 text-rose-800 ring-rose-100'}`}>
                    <span className="font-bold text-xs uppercase tracking-wider opacity-70">盈虧</span><span className="font-black text-2xl tracking-tight font-mono">{profitLoss>0?'+':''}{formatCurrency(profitLoss)}</span>
                </div>
                <div className="mt-2 text-[10px] text-slate-400 text-center">兌幣機記錄: {formatCurrency(Number(extraData?.exchangeMachineCash)||0)}</div>
            </div>
        </div>
    );
};

// --- App ---
const App = () => {
    const [user, setUser] = useState(null);
    const [activeTab, setActiveTab] = useState('input');
    const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
    const [machines, setMachines] = useState([]);
    const [dailyData, setDailyData] = useState({});
    const [extraData, setExtraData] = useState({ previousCash: '', exchangeMachineCash: '' });
    const [historyData, setHistoryData] = useState([]);
    const [memos, setMemos] = useState([]);
    const [loading, setLoading] = useState(true);
    const [cashCounts, setCashCounts] = useState({ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 });
    const [openMonths, setOpenMonths] = useState({});
    const [isAdmin, setIsAdmin] = useState(false);
    const [showLogin, setShowLogin] = useState(false);
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    
    // Memo Inputs
    const [memoName, setMemoName] = useState('');
    const [memoText, setMemoText] = useState('');

    useEffect(() => { auth.signInAnonymously().catch(console.error); return auth.onAuthStateChanged(setUser); }, []);
    useEffect(() => { const s=localStorage.getItem('isAdmin'); if(s==='true') setIsAdmin(true); }, []);

    const handleLogin = (e) => { e.preventDefault(); if(username==='Colason'&&password==='Colason'){ setIsAdmin(true); localStorage.setItem('isAdmin','true'); setShowLogin(false); setUsername(''); setPassword(''); } else alert('錯誤'); };
    const handleLogout = () => { setIsAdmin(false); localStorage.removeItem('isAdmin'); alert('已登出'); };

    // Fetchers
    useEffect(() => { if (!user) return; return db.collection('machines').onSnapshot(snap => { if (snap.empty) { const defaults = [{ id: '1', name: '機台 1', owner: '台主在場', phone: '60299392', coinValue: 5 }, { id: '2', name: '機台 2', owner: '62778117', phone: '62778117', coinValue: 5 }, { id: '3', name: '機台 3', owner: '群組', phone: '91696461', coinValue: 5 }, { id: '4', name: '機台 4', owner: '97859062', phone: '97859062', coinValue: 5 }, { id: '5', name: '機台 5', owner: '大家姐', phone: '', coinValue: 5 }, { id: '6', name: '機台 6', owner: '西裝', phone: '', coinValue: 5 }, { id: '7', name: '機台 7', owner: '大家姐', phone: '', coinValue: 5 }]; defaults.forEach(m => db.collection('machines').doc(m.id).set(m)); setMachines(defaults); } else { const loaded = snap.docs.map(d => ({id: d.id, ...d.data()})); loaded.sort((a,b) => parseInt(a.id)-parseInt(b.id)); setMachines(loaded); } setLoading(false); }); }, [user]);
    useEffect(() => { if (!user) return; return db.collection('daily_records').doc(selectedDate).onSnapshot(doc => { if (doc.exists) { const d = doc.data(); setDailyData(d.records||{}); setCashCounts(d.cashCounts||{ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 }); setExtraData(d.extraData||{ previousCash: '', exchangeMachineCash: '' }); } else { setDailyData({}); setCashCounts({ '1000': 0, '500': 0, '100': 0, '50': 0, '20': 0, '10': 0, 'coins': 0 }); setExtraData({ previousCash: '', exchangeMachineCash: '' }); } }); }, [user, selectedDate]);
    useEffect(() => { if (!user) return; return db.collection('daily_records').onSnapshot(snap => { const recs = snap.docs.map(d => ({ date: d.id, ...d.data() })).filter(r => r.date.match(/^\d{4}-\d{2}-\d{2}$/)); recs.sort((a, b) => b.date.localeCompare(a.date)); setHistoryData(recs); }); }, [user]);
    useEffect(() => { if (historyData.length > 0 && Object.keys(openMonths).length === 0) setOpenMonths({ [historyData[0].date.substring(0, 7)]: true }); }, [historyData]);
    
    // Memos Fetcher
    useEffect(() => {
        if (!user) return;
        return db.collection('memos').orderBy('createdAt', 'desc').onSnapshot(snap => {
            const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setMemos(list);
        });
    }, [user]);

    // Handlers
    const handleCountChange = (id, field, val, coinVal) => { if (!isAdmin) return; const amt = isNaN(parseFloat(val)) ? '' : parseFloat(val) * (coinVal || 5); setDailyData(prev => ({ ...prev, [id]: { ...(prev[id]||{}), [field]: amt } })); };
    const handleWhatsApp = (m) => { 
        const r = dailyData[m.id]||{}; 
        const upperVal = Number(r.upper) || 0;
        const lowerVal = Number(r.lower) || 0;
        const totalVal = upperVal + lowerVal;

        if(!m.phone) return alert('請先在「設定」輸入電話');
        
        const msg = `今天對幣：\n上層：$${upperVal}\n下層：$${lowerVal}\n總共：$${totalVal}`;
        window.open(`https://wa.me/${m.phone.replace(/\s+/g,'')}?text=${encodeURIComponent(msg)}`, '_blank'); 
    };
    const saveData = async () => { if (!user || !isAdmin) return; const processed = {}; const allIds = new Set([...machines.map(m=>m.id), ...Object.keys(dailyData)]); allIds.forEach(id => { const r = dailyData[id]||{}; processed[id] = { upper: r.upper||'', lower: r.lower||'', total: (Number(r.upper)||0)+(Number(r.lower)||0), isPaid: r.isPaid||false }; }); await db.collection('daily_records').doc(selectedDate).set({ records: processed, cashCounts, extraData, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); alert('資料已儲存！'); };
    const deleteRecord = async (date) => { if(!isAdmin) return; if(confirm(`刪除 ${date} 紀錄？`)) await db.collection('daily_records').doc(date).delete(); };
    const deleteMonth = async (month, recs) => { if(!isAdmin) return; if(confirm(`刪除 ${month} 所有資料 (${recs.length}筆)？`)) { const batch = db.batch(); recs.forEach(r => batch.delete(db.collection('daily_records').doc(r.date))); await batch.commit(); alert('已刪除月份資料'); } };
    
    // Memo Handlers
    const addMemo = async () => {
        if (!memoName.trim()) return alert('請輸入姓名');
        if (!memoText.trim()) return alert('請輸入內容');
        try {
            await db.collection('memos').add({
                name: memoName,
                text: memoText,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setMemoText(''); // Keep name for convenience
        } catch(e) { console.error(e); alert('留言失敗'); }
    };
    const deleteMemo = async (id) => {
        if (!isAdmin) return;
        if (confirm('刪除此留言？')) await db.collection('memos').doc(id).delete();
    };

    // Render Logic
    const renderInput = () => {
        const totalRev = machines.reduce((s,m) => s + (Number(dailyData[m.id]?.upper)||0) + (Number(dailyData[m.id]?.lower)||0), 0);
        const currCash = ((cashCounts['1000']||0)*1000)+((cashCounts['500']||0)*500)+((cashCounts['100']||0)*100)+((cashCounts['50']||0)*50)+((cashCounts['20']||0)*20)+((cashCounts['10']||0)*10)+(Number(cashCounts['coins'])||0);
        const pl = (currCash + (Number(extraData.previousCash)||0)) - totalRev;

        return (
            <div className="space-y-6 animate-fade-in">
                <div className="glass-panel p-2 rounded-2xl flex items-center relative overflow-hidden">
                    <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-indigo-400 to-purple-500"></div>
                    <div className="pl-4 py-3 flex-1"><label className="block text-[10px] font-bold text-indigo-500/80 uppercase">選擇日期</label><div className="font-black text-slate-700 text-xl flex items-center gap-2"><span className="text-indigo-500"><Icons.Calendar/></span>{selectedDate}</div></div>
                    
                    {/* Today Button - Higher Z-Index to be clickable */}
                    <button 
                        onClick={(e) => {
                            e.stopPropagation(); 
                            setSelectedDate(formatDate(new Date()));
                        }}
                        className="relative z-20 mr-2 bg-white/50 hover:bg-white text-indigo-600 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm backdrop-blur-sm border border-white/50 transition-all active:scale-95"
                    >
                        今天
                    </button>

                    <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="absolute inset-0 opacity-0 w-full h-full z-10 cursor-pointer"/>
                </div>
                {!isAdmin && <div className="bg-slate-200/80 p-3 rounded-xl text-xs text-slate-600 text-center flex items-center justify-center gap-2"><Icons.Lock/> 訪客模式：只能查看，無法編輯</div>}
                
                <div className="space-y-5">
                    {machines.map(m => {
                        const d = dailyData[m.id]||{}; const cv = m.coinValue||5; const sub = (Number(d.upper)||0)+(Number(d.lower)||0);
                        return (
                            <div key={m.id} className={`glass-panel rounded-3xl overflow-hidden ${!isAdmin?'locked-element':''}`}>
                                <div className="bg-white/40 px-5 py-4 border-b border-white/50 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-lg">{m.id}</div><div><h3 className="font-bold text-slate-800 text-lg">{m.name}</h3><p className="text-[11px] text-slate-500 font-medium">幣值: ${cv}</p></div></div><div className="text-right"><span className="text-[10px] text-slate-400 block font-bold">小計</span><span className="font-black text-indigo-600 text-xl">{formatCurrency(sub).replace('HK$','')}</span></div></div>
                                <div className="p-5 grid grid-cols-2 gap-4">
                                    <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">上層個數</label><input disabled={!isAdmin} type="number" placeholder="0" value={d.upper?(Number(d.upper)/cv):''} onChange={e=>handleCountChange(m.id,'upper',e.target.value,cv)} className="glass-input w-full py-3 px-2 rounded-2xl text-center font-bold text-slate-700 text-lg focus:bg-white outline-none"/><div className="text-center text-[10px] text-slate-400">= ${Number(d.upper)||0}</div></div>
                                    <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">下層個數</label><input disabled={!isAdmin} type="number" placeholder="0" value={d.lower?(Number(d.lower)/cv):''} onChange={e=>handleCountChange(m.id,'lower',e.target.value,cv)} className="glass-input w-full py-3 px-2 rounded-2xl text-center font-bold text-slate-700 text-lg focus:bg-white outline-none"/><div className="text-center text-[10px] text-slate-400">= ${Number(d.lower)||0}</div></div>
                                </div>
                                <div className="px-5 pb-5"><button onClick={()=>handleWhatsApp(m)} className="w-full py-3 rounded-xl bg-emerald-50 text-emerald-600 font-bold text-sm flex items-center justify-center gap-2 hover:bg-emerald-100 active:scale-95"><Icons.Whatsapp/> 報數到 WhatsApp</button></div>
                            </div>
                        )
                    })}
                </div>

                <div className={`glass-panel p-5 rounded-3xl mt-8 ${!isAdmin?'locked-element':''}`}>
                    <h3 className="font-bold mb-4 text-slate-700 flex items-center gap-2 text-lg"><span className="w-1.5 h-6 rounded-full bg-gradient-to-b from-emerald-400 to-teal-500"></span>現金點算</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {['1000','500','100','50','20','10'].map(d=>(<div key={d} className="relative"><label className="absolute -top-2 left-3 bg-white/90 px-1.5 rounded text-[10px] font-bold text-emerald-600">${d}</label><div className="flex items-center"><input disabled={!isAdmin} type="number" placeholder="0" value={cashCounts[d]||''} onChange={e=>setCashCounts(prev=>({...prev,[d]:parseFloat(e.target.value)||0}))} className="glass-input w-full py-3 px-4 rounded-xl font-bold text-slate-700 focus:bg-white outline-none"/></div><div className="text-right text-[10px] text-slate-400 mt-1 mr-1 opacity-60">= {formatCurrency((cashCounts[d]||0)*d).replace('HK$','')}</div></div>))}
                        <div className="col-span-2 relative mt-3"><label className="absolute -top-2 left-3 bg-white/90 px-1.5 rounded text-[10px] font-bold text-amber-500">硬幣總額</label><input disabled={!isAdmin} type="number" placeholder="0" value={cashCounts['coins']||''} onChange={e=>setCashCounts(prev=>({...prev,['coins']:parseFloat(e.target.value)||0}))} className="glass-input w-full py-3 px-4 rounded-xl font-bold text-slate-700 focus:bg-white outline-none"/></div>
                    </div>
                    <div className="mt-5 pt-4 border-t border-slate-200/50 flex justify-between font-bold text-sm"><span className="text-slate-500">本次紙幣小計</span><span className="text-emerald-600 text-xl font-black">{formatCurrency(currCash)}</span></div>
                </div>

                <div className={`glass-panel p-5 rounded-3xl mt-4 space-y-5 ${!isAdmin?'locked-element':''}`}>
                    <div><label className="text-xs font-bold text-slate-500 ml-1">上次數到的紙幣</label><input disabled={!isAdmin} type="number" placeholder="0" value={extraData.previousCash} onChange={e=>setExtraData(prev=>({...prev,previousCash:e.target.value}))} className="glass-input w-full py-3 px-4 rounded-xl focus:bg-white outline-none font-bold text-slate-700 text-lg"/></div>
                    <div><label className="text-xs font-bold text-slate-500 ml-1">兌幣機現有紙幣</label><input disabled={!isAdmin} type="number" placeholder="0" value={extraData.exchangeMachineCash} onChange={e=>setExtraData(prev=>({...prev,exchangeMachineCash:e.target.value}))} className="glass-input w-full py-3 px-4 rounded-xl focus:bg-white outline-none font-bold text-slate-700 text-lg"/></div>
                </div>

                <DailySummaryTable machines={machines} data={dailyData} cashCounts={cashCounts} extraData={extraData} onTogglePaid={(id,st)=>{if(isAdmin)setDailyData(prev=>({...prev,[id]:{...(prev[id]||{}),isPaid:st}}))}}/>
                
                {/* Memo Board */}
                <div className="glass-panel p-5 rounded-3xl mt-8">
                    <h3 className="font-bold mb-4 text-slate-700 flex items-center gap-2 text-lg"><span className="w-1.5 h-6 rounded-full bg-indigo-500"></span>留言備忘板</h3>
                    
                    {/* Memo List */}
                    <div className="space-y-3 mb-6 max-h-[400px] overflow-y-auto pr-1">
                        {memos.length === 0 && <div className="text-center text-slate-400 text-xs py-4">暫無留言</div>}
                        {memos.map(memo => (
                            <div key={memo.id} className="bg-white/60 p-3 rounded-2xl rounded-tl-none relative group">
                                <div className="flex justify-between items-start">
                                    <div className="flex flex-col">
                                        <span className="text-[11px] font-bold text-indigo-600">{memo.name}</span>
                                        <span className="text-[9px] text-slate-400">{formatTime(memo.createdAt)}</span>
                                    </div>
                                    {isAdmin && <button onClick={()=>deleteMemo(memo.id)} className="text-slate-300 hover:text-rose-500 p-1"><Icons.Trash2/></button>}
                                </div>
                                <div className="mt-1 text-sm text-slate-700 font-medium whitespace-pre-wrap leading-relaxed">{memo.text}</div>
                            </div>
                        ))}
                    </div>

                    {/* Memo Input */}
                    <div className="space-y-3 bg-white/40 p-3 rounded-2xl">
                        <input value={memoName} onChange={e=>setMemoName(e.target.value)} placeholder="輸入您的姓名..." className="w-full bg-white/50 border-none rounded-xl px-3 py-2 text-sm font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-400 outline-none"/>
                        <textarea value={memoText} onChange={e=>setMemoText(e.target.value)} placeholder="輸入備忘事項..." rows="2" className="w-full bg-white/50 border-none rounded-xl px-3 py-2 text-sm text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-400 outline-none resize-none"></textarea>
                        <button onClick={addMemo} className="w-full bg-indigo-500 text-white rounded-xl py-2.5 font-bold text-sm flex items-center justify-center gap-2 hover:bg-indigo-600 active:scale-95 transition-all"><Icons.Message/> 發送留言</button>
                    </div>
                </div>

                <div className="h-40"></div>

                {/* Floating Dock Fixed at Bottom */}
                <div className="glass-dock fixed bottom-[85px] left-4 right-4 p-4 rounded-3xl flex justify-between items-center z-40">
                    <div><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">本日總盈虧</p><p className={`text-2xl font-black tracking-tight ${pl>=0?'text-emerald-500':'text-rose-500'}`}>{pl>0?'+':''}{formatCurrency(pl)}</p></div>
                    {isAdmin ? <button onClick={saveData} className="bg-slate-900 text-white px-8 py-3.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg active:scale-95 text-sm transition-all"><Icons.Save/> 儲存</button> : <button disabled className="bg-slate-300 text-slate-500 px-8 py-3.5 rounded-2xl font-bold flex items-center gap-2 shadow-inner text-sm"><Icons.Lock/> 訪客</button>}
                </div>
            </div>
        );
    };

    const renderHistory = () => {
        if (!historyData.length) return <div className="flex flex-col items-center py-20 text-slate-400"><Icons.Empty/><p className="mt-4 font-bold text-sm">暫無紀錄，請先新增資料。</p></div>;
        const groups = {}; historyData.forEach(r => { const k=r.date.substring(0,7); if(!groups[k]) groups[k]=[]; groups[k].push(r); });
        return (
            <div className="space-y-6 animate-fade-in">
                <h2 className="text-3xl font-black text-slate-800 px-1">歷史紀錄</h2>
                {Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0])).map(([mKey, recs]) => {
                    const profit = recs.reduce((acc, r) => { const tr = Object.values(r.records||{}).reduce((s,v)=>s+(Number(v.total)||0),0); const cc = Object.entries(r.cashCounts||{}).reduce((s,[k,v])=>k==='coins'?s+v:s+(v*Number(k)),0); return acc + ((cc + (Number(r.extraData?.previousCash)||0)) - tr); }, 0);
                    const open = openMonths[mKey];
                    return (
                        <div key={mKey} className="space-y-2">
                            <div className={`glass-panel p-4 rounded-3xl flex justify-between items-center bg-white/40 ${open?'ring-2 ring-indigo-200 bg-white/70':''}`}>
                                <div className="flex items-center gap-3 flex-1 cursor-pointer" onClick={()=>setOpenMonths(p=>({...p,[mKey]:!p[mKey]}))}><div className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-colors ${open?'bg-indigo-500 text-white':'bg-indigo-50 text-indigo-400'}`}><Icons.Folder/></div><div><h3 className="font-bold text-slate-700 text-lg">{mKey.split('-')[0]}年 {mKey.split('-')[1]}月</h3><p className="text-[10px] text-slate-500 font-medium">{recs.length} 筆帳目</p></div></div>
                                <div className="flex items-center gap-3"><div className={`font-black text-lg ${profit>=0?'text-emerald-600':'text-rose-500'}`}>{profit>0?'+':''}{formatCurrency(profit).replace('HK$','')}</div>{isAdmin ? <button onClick={()=>deleteMonth(mKey, recs)} className="w-8 h-8 flex items-center justify-center rounded-full bg-rose-100 text-rose-500"><Icons.Trash2/></button> : <div className="w-8 h-8 flex items-center justify-center text-slate-300"><Icons.Lock/></div>}</div>
                            </div>
                            {open && <div className="space-y-3 pl-4 border-l-2 border-indigo-100/50 ml-6 pt-2">{recs.map(r => {
                                const tr = Object.values(r.records||{}).reduce((s,v)=>s+(Number(v.total)||0),0); const cc = Object.entries(r.cashCounts||{}).reduce((s,[k,v])=>k==='coins'?s+v:s+(v*Number(k)),0); const p = (cc + (Number(r.extraData?.previousCash)||0)) - tr;
                                return (<div key={r.date} className="glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-white/60 ml-2" onClick={()=>{setSelectedDate(r.date);setActiveTab('input');}}><div className="flex items-center gap-3"><span className="font-bold text-slate-700">{r.date.substring(8)}日</span><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-400">查看</span></div><div className="flex items-center gap-3"><span className={`font-black ${p>=0?'text-emerald-500':'text-rose-500'}`}>{Math.round(p)}</span>{isAdmin ? <button onClick={(e)=>{e.stopPropagation();deleteRecord(r.date);}} className="p-2 text-slate-300 hover:text-rose-500"><Icons.Trash2/></button> : <span className="p-2 text-slate-300"><Icons.Lock/></span>}</div></div>)
                            })}</div>}
                        </div>
                    );
                })}
            </div>
        );
    };

    const renderSettings = () => (
        <div className="space-y-4 animate-fade-in">
            <h2 className="text-3xl font-black text-slate-800 px-1">機台設定</h2>
            {!isAdmin && <div className="bg-slate-200/80 p-4 rounded-2xl text-sm font-bold text-slate-600 flex items-center justify-center gap-2 mb-4"><Icons.Lock/> 設定已鎖定 (訪客模式)</div>}
            <div className="space-y-3">{machines.map((m, i) => (
                <div key={m.id} className={`glass-panel p-4 rounded-3xl flex gap-3 items-center ${!isAdmin?'locked-element':''}`}>
                    <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600 flex items-center justify-center font-bold text-lg shrink-0">{m.id}</div>
                    <div className="flex-1 space-y-2"><input disabled={!isAdmin} value={m.name} onChange={e=>{const n=[...machines];n[i].name=e.target.value;setMachines(n)}} className="w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none font-bold text-slate-700"/><div className="flex gap-2"><input disabled={!isAdmin} placeholder="台主" value={m.owner} onChange={e=>{const n=[...machines];n[i].owner=e.target.value;setMachines(n)}} className="text-xs w-full bg-slate-50/50 rounded-lg px-2 py-1.5 border-none"/><input disabled={!isAdmin} placeholder="電話" value={m.phone} onChange={e=>{const n=[...machines];n[i].phone=e.target.value;setMachines(n)}} className="text-xs w-full bg-slate-50/50 rounded-lg px-2 py-1.5 border-none text-right"/></div></div>
                    {isAdmin ? <button onClick={async()=>{if(confirm('刪除?'))await db.collection('machines').doc(m.id).delete()}} className="w-10 h-10 flex items-center justify-center rounded-xl bg-rose-50 text-rose-500"><Icons.Trash2/></button> : <span className="text-slate-300"><Icons.Lock/></span>}
                </div>
            ))}</div>
            {isAdmin ? <><button onClick={async()=>{const newId=(machines.reduce((max,m)=>Math.max(max,parseInt(m.id)||0),0)+1).toString();await db.collection('machines').doc(newId).set({id:newId,name:`機台 ${newId}`,coinValue:5})}} className="w-full py-4 border-2 border-dashed border-slate-300/60 rounded-3xl text-slate-400 font-bold flex justify-center gap-2"><Icons.Plus/> 新增機台</button><button onClick={async()=>{for(const m of machines)await db.collection('machines').doc(m.id).set(m);alert('設定已儲存')}} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl mt-4 active:scale-95">儲存設定</button></> : <button disabled className="w-full bg-slate-300 text-slate-500 py-4 rounded-2xl font-bold shadow-inner mt-4 flex items-center justify-center gap-2"><Icons.Lock/> 權限不足</button>}
        </div>
    );

    return (
        <div className="min-h-screen">
            <div className="glass-nav sticky top-0 z-40 mb-6"><div className="max-w-lg mx-auto px-5 py-4 flex justify-between items-center"><div><h1 className="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">娛樂基地</h1><p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Pro Management</p></div><div className="flex items-center gap-3"><div className="text-xs font-bold bg-slate-100/80 px-3 py-1.5 rounded-full text-slate-600">{selectedDate}</div><button onClick={()=>isAdmin?handleLogout():setShowLogin(true)} className={`p-2 rounded-full transition-all ${isAdmin?'bg-indigo-100 text-indigo-600':'bg-slate-200 text-slate-500'}`}>{isAdmin?<Icons.Unlock/>:<Icons.Lock/>}</button></div></div></div>
            {showLogin && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in"><div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-slate-800">管理員登入</h3><button onClick={()=>setShowLogin(false)} className="text-slate-400"><Icons.Close/></button></div><form onSubmit={handleLogin} className="space-y-4"><input type="text" placeholder="帳號" value={username} onChange={e=>setUsername(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700"/><input type="password" placeholder="密碼" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700"/><button type="submit" className="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold shadow-lg">登入</button></form></div></div>}
            <div className="px-4 max-w-lg mx-auto pb-[400px]">{loading?<div className="flex flex-col items-center py-20"><div className="w-10 h-10 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin"></div></div>:(activeTab==='input'?renderInput():activeTab==='history'?renderHistory():renderSettings())}</div>
            <div className="glass-nav fixed bottom-0 left-0 right-0 pb-safe z-30 h-[80px] flex items-center"><div className="flex justify-around w-full max-w-lg mx-auto"><button onClick={()=>setActiveTab('input')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-20 h-16 ${activeTab==='input'?'text-indigo-600 bg-indigo-50/50 scale-105':'text-slate-400'}`}><Icons.LayoutDashboard/><span className="text-[10px] font-bold mt-1">輸入</span></button><button onClick={()=>setActiveTab('history')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-20 h-16 ${activeTab==='history'?'text-indigo-600 bg-indigo-50/50 scale-105':'text-slate-400'}`}><Icons.History/><span className="text-[10px] font-bold mt-1">歷史</span></button><button onClick={()=>setActiveTab('settings')} className={`flex flex-col items-center justify-center p-2 rounded-2xl w-20 h-16 ${activeTab==='settings'?'text-indigo-600 bg-indigo-50/50 scale-105':'text-slate-400'}`}><Icons.Settings/><span className="text-[10px] font-bold mt-1">設定</span></button></div></div>
        </div>
    );
};
const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
</script>
</body>
</html>


